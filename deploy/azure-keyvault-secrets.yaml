# =============================================================================
# Azure Key Vault Integration for AKS
# =============================================================================
# Prerequisites:
# 1. Enable Key Vault Secrets Store CSI Driver on AKS:
#    az aks enable-addons --addons azure-keyvault-secrets-provider --name <aks-name> --resource-group <rg-name>
#
# 2. Create a Key Vault and add secrets:
#    az keyvault create --name <keyvault-name> --resource-group <rg-name> --location <location>
#    az keyvault secret set --vault-name <keyvault-name> --name "azure-openai-api-key" --value "your-api-key"
#    az keyvault secret set --vault-name <keyvault-name> --name "azure-openai-endpoint" --value "https://your-resource.openai.azure.com/"
#
# 3. Grant AKS managed identity access to Key Vault:
#    az keyvault set-policy --name <keyvault-name> --spn <aks-managed-identity-client-id> --secret-permissions get
# =============================================================================

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-keyvault-secrets
  namespace: devops-tools
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: ""  # Leave empty if using system-assigned identity
    keyvaultName: "YOUR_KEYVAULT_NAME"  # Replace with your Key Vault name
    tenantId: "YOUR_TENANT_ID"  # Replace with your Azure AD tenant ID
    objects: |
      array:
        - |
          objectName: azure-openai-api-key
          objectType: secret
        - |
          objectName: azure-openai-endpoint
          objectType: secret
  # Sync secrets to Kubernetes Secret (optional but recommended)
  secretObjects:
    - secretName: ai-kustomize-agent-secrets
      type: Opaque
      data:
        - objectName: azure-openai-api-key
          key: AZURE_OPENAI_API_KEY
        - objectName: azure-openai-endpoint
          key: AZURE_OPENAI_ENDPOINT
